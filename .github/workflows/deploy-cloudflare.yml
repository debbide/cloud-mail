name: ğŸš€ Deploy cloud-mail to Cloudflare Workers

on:
  push:
    branches: [ main ]
    paths:
      - "mail-worker/**"
      - "mail-vue/**"
  workflow_dispatch:

jobs:
  Deploy-cloud-mail:
    name: ğŸ—ï¸ Build and Deploy
    runs-on: ubuntu-latest

    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      D1_DATABASE_ID: ${{ secrets.D1_DATABASE_ID }}
      KV_NAMESPACE_ID: ${{ secrets.KV_NAMESPACE_ID }}
      R2_BUCKET_NAME: ${{ secrets.R2_BUCKET_NAME }}
      DOMAIN: ${{ secrets.DOMAIN }}
      ADMIN: ${{ secrets.ADMIN }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      LINUXDO_CLIENT_ID: ${{ secrets.LINUXDO_CLIENT_ID }}
      LINUXDO_CLIENT_SECRET: ${{ secrets.LINUXDO_CLIENT_SECRET }}
      LINUXDO_CALLBACK_URL: ${{ secrets.LINUXDO_CALLBACK_URL }}
      LINUXDO_SWITCH: ${{ secrets.LINUXDO_SWITCH }}

    outputs:
      deployment_skipped: ${{ steps.deploy.outputs.deployment_skipped }}
      worker_url: ${{ steps.deploy.outputs.worker_url }}

    steps:
      - name: â¡ï¸ æ£€å‡ºä»£ç ä»“åº“ - Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ è®¾ç½® pnpm - Setup pnpm
        uses: pnpm/action-setup@v4.1.0
        with:
          version: latest

      - name: ğŸ“¦ è®¾ç½® Node.js - Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"
          cache-dependency-path: "./mail-worker/pnpm-lock.yaml"

      - name: ğŸ“¥ å®‰è£…ä¾èµ– - Install dependencies
        run: pnpm install --frozen-lockfile
        working-directory: ./mail-worker

      - name: ğŸ“¡ ç¦ç”¨ Wrangler é¥æµ‹ - Disable wrangler telemetry
        working-directory: ./mail-worker
        run: npx wrangler telemetry disable

      - name: ğŸ› ï¸ è®¾ç½®ç¯å¢ƒå˜é‡å’Œéƒ¨ç½² - Set Secrets and Deploy
        id: deploy
        working-directory: ./mail-worker
        run: |
          if [ -z "$D1_DATABASE_ID" ] || [ -z "$KV_NAMESPACE_ID" ]; then
            echo "âš ï¸ Required secrets (D1_DATABASE_ID or KV_NAMESPACE_ID) are not set."
            echo "âŒ Skipping deployment."
            echo "deployment_skipped=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "deployment_skipped=false" >> $GITHUB_OUTPUT
          
          CONFIG_FILE="wrangler-action.toml"
          
          if [ -z "$R2_BUCKET_NAME" ]; then
            sed -i "18,20d" "$CONFIG_FILE"
          fi
          
          echo "âš™ï¸ Dynamically updating '$CONFIG_FILE' with binding IDs..."

          # Use a safer approach with awk to avoid sed special character issues
          awk -v d1="$D1_DATABASE_ID" '{gsub(/\$\{D1_DATABASE_ID\}/, d1)}1' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
          awk -v kv="$KV_NAMESPACE_ID" '{gsub(/\$\{KV_NAMESPACE_ID\}/, kv)}1' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
          awk -v r2="$R2_BUCKET_NAME" '{gsub(/\$\{R2_BUCKET_NAME\}/, r2)}1' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
          awk -v domain="$DOMAIN" '{gsub(/"\$\{DOMAIN\}"/, domain)}1' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
          awk -v admin="$ADMIN" '{gsub(/\$\{ADMIN\}/, admin)}1' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
          awk -v jwt="$JWT_SECRET" '{gsub(/\$\{JWT_SECRET\}/, jwt)}1' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
          awk -v clientid="$LINUXDO_CLIENT_ID" '{gsub(/\$\{LINUXDO_CLIENT_ID\}/, clientid)}1' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
          awk -v secret="$LINUXDO_CLIENT_SECRET" '{gsub(/\$\{LINUXDO_CLIENT_SECRET\}/, secret)}1' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
          awk -v callback="$LINUXDO_CALLBACK_URL" '{gsub(/\$\{LINUXDO_CALLBACK_URL\}/, callback)}1' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"
          awk -v switch="$LINUXDO_SWITCH" '{gsub(/\$\{LINUXDO_SWITCH\}/, switch)}1' "$CONFIG_FILE" > "${CONFIG_FILE}.tmp" && mv "${CONFIG_FILE}.tmp" "$CONFIG_FILE"

          echo "ğŸ” Debug: Checking configuration after replacement..."
          echo "R2_BUCKET_NAME value: '$R2_BUCKET_NAME'"
          echo "R2 bucket configuration in $CONFIG_FILE:"
          grep -A 2 -B 2 "bucket_name" "$CONFIG_FILE" || true

          echo "ğŸ”’ Setting Worker secrets..."
          echo "ğŸš€ Configuration updated. Starting deployment..."
          npx wrangler deploy -c "$CONFIG_FILE" | tee deploy.log | grep -v "https://.*\.workers\.dev"
          WORKER_URL=$(grep -o "https://.*\.workers\.dev" deploy.log)
          echo "::add-mask::$WORKER_URL"
          echo "worker_url=$WORKER_URL" >> $GITHUB_OUTPUT
          echo "âœ… Deployment command executed."

      - name: ğŸ—„ï¸ åˆå§‹åŒ–æ•°æ®åº“ - Initialize Database
        if: ${{ steps.deploy.outputs.deployment_skipped == 'false' }}
        run: |
          
          echo "â³ Waiting 15s before checking initialization status..."
          sleep 15
          
          HTTP_CODE=$(curl -s -w "%{http_code}" -o response.txt "${{ steps.deploy.outputs.worker_url }}/api/init/${JWT_SECRET}")
          RESPONSE_BODY=$(cat response.txt)
          
          echo "ğŸ” Checking response... (Status: $HTTP_CODE)"

          if [ "$HTTP_CODE" = "200" ] && [ "$RESPONSE_BODY" = "åˆå§‹åŒ–æˆåŠŸ" -o "$RESPONSE_BODY" = "Successfully initialized" ]; then
            echo "âœ… Database initialization successful!"
          elif [ "$HTTP_CODE" = "200" ]; then
            echo "âŒ Database initialization error: $RESPONSE_BODY"
          else
            echo "âŒ Database initialization check failed with HTTP status: $HTTP_CODE. response: $RESPONSE_BODY"
          fi

      - name: ğŸ“£ éƒ¨ç½²çŠ¶æ€ - Notify Final Status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            if [ "${{ steps.deploy.outputs.deployment_skipped }}" == "true" ]; then
              echo "âŒ Deployment was skipped due to missing configuration."
            else
              echo "ğŸ‰ğŸ‰ğŸ‰ Hooray! Deployment completed successfully! ğŸ‰ğŸ‰ğŸ‰"
            fi
          else
            echo "âŒâŒâŒ Oh no! The deployment failed. Please check the logs above for errors. âŒâŒâŒ"
          fi

      - name: Delete workflow runs
        uses: GitRML/delete-workflow-runs@main
        continue-on-error: true
        with:
          retain_days: '3'
          keep_minimum_runs: '0'
